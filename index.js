// index.js - Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„Ð°Ð¹Ð» ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ Telegram-Ð±Ð¾Ñ‚Ð¾Ð¼
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const TelegramBot = require('node-telegram-bot-api');
const path = require('path');

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Express Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
const app = express();
const PORT = process.env.PORT || 3000;

// Ð¢Ð¾ÐºÐµÐ½ Ð²Ð°ÑˆÐµÐ³Ð¾ Telegram-Ð±Ð¾Ñ‚Ð° (Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ð²Ð°Ñˆ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½)
const token = '7649901748:AAE-yAcdXAQKmIoO45ErEdVfdicBGD6dwKs';

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð° Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ polling (Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸)
const bot = new TelegramBot(token, { polling: true });

// Middleware
app.use(bodyParser.json());
app.use(cors());

// Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Express Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Ð¿Ð°Ð¿ÐºÐ¸ public
app.use(express.static(path.join(__dirname, 'public'))); // Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ

// ðŸŸ£ ÐžÑ‚Ð´Ð°Ñ‘Ð¼ index.html Ð¿Ñ€Ð¸ Ð·Ð°Ñ…Ð¾Ð´Ðµ Ð½Ð° /
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'html.html')); // ÐŸÑƒÑ‚ÑŒ Ðº Ñ‚Ð²Ð¾ÐµÐ¼Ñƒ html Ñ„Ð°Ð¹Ð»Ñƒ
});

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸
app.post('/book', (req, res) => {
  const { service, staff, date, time } = req.body;

  if (!service || !staff || !date || !time) {
    return res.status(400).json({
      success: false,
      error: 'ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ'
    });
  }

  const message = `
ðŸ’‡ *ÐÐ¾Ð²Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ*

ðŸ”¹ Ð£ÑÐ»ÑƒÐ³Ð°: ${service}
ðŸ‘©â€ðŸ¦° Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº: ${staff}
ðŸ“… Ð”Ð°Ñ‚Ð°: ${date}
â° Ð’Ñ€ÐµÐ¼Ñ: ${time}
  `;

  const chatId = '1005939833';

  bot.sendMessage(chatId, message, { parse_mode: 'Markdown' })
    .then(() => {
      console.log('Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ');
      res.status(200).json({
        success: true,
        message: 'Ð—Ð°Ð¿Ð¸ÑÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð°!'
      });
    })
    .catch((error) => {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', error);
      res.status(500).json({
        success: false,
        error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ'
      });
    });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Telegram-Ð±Ð¾Ñ‚Ð°
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const firstName = msg.from.first_name || '';

  const welcomeMessage = `
ÐŸÑ€Ð¸Ð²ÐµÑ‚, ${firstName}! ðŸ‘‹

Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð±Ð¾Ñ‚ Ð½Ð°ÑˆÐµÐ³Ð¾ ÑÐ°Ð»Ð¾Ð½Ð°.
Ð—Ð´ÐµÑÑŒ Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ:
â€¢ ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ñ‚ÑŒ ÑÐ²Ð¾Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸
â€¢ Ð£Ð·Ð½Ð°Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐ°Ð»Ð¾Ð½Ðµ
â€¢ Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼

Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñ‡Ñ‚Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð½Ð°Ñ!
  `;

  bot.sendMessage(chatId, welcomeMessage, {
    reply_markup: {
      keyboard: [
        ['ðŸ’‡â€â™€ï¸ ÐœÐ¾Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸'],
        ['â„¹ï¸ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ°Ð»Ð¾Ð½Ðµ'],
        ['ðŸ“ž Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð½Ð°Ð¼Ð¸']
      ],
      resize_keyboard: true
    }
  });
});

bot.onText(/ðŸ’‡â€â™€ï¸ ÐœÐ¾Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, 'Ð’ Ð½Ð°ÑÑ‚Ð¾ÑÑ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ñƒ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹. Ð§Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ, Ð¿Ð¾ÑÐµÑ‚Ð¸Ñ‚Ðµ Ð½Ð°Ñˆ ÑÐ°Ð¹Ñ‚.');
});

bot.onText(/â„¹ï¸ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ°Ð»Ð¾Ð½Ðµ/, (msg) => {
  const chatId = msg.chat.id;
  const infoMessage = `
*Ðž Ð½Ð°ÑˆÐµÐ¼ ÑÐ°Ð»Ð¾Ð½Ðµ*

ðŸ  ÐÐ´Ñ€ÐµÑ: [Ð’Ð°Ñˆ Ð°Ð´Ñ€ÐµÑ]
â° Ð“Ñ€Ð°Ñ„Ð¸Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹: ÐŸÐ½-Ð’Ñ Ñ 10:00 Ð´Ð¾ 20:00
ðŸ“ž Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: [Ð’Ð°Ñˆ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½]
ðŸŒ Ð¡Ð°Ð¹Ñ‚: [Ð’Ð°Ñˆ ÑÐ°Ð¹Ñ‚]
  `;
  bot.sendMessage(chatId, infoMessage, { parse_mode: 'Markdown' });
});

bot.onText(/ðŸ“ž Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð½Ð°Ð¼Ð¸/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, 'ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ, Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ Ð²Ð°Ð¼ Ð² Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ.');
});

// ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('message', (msg) => {
  const chatId = msg.chat.id;

  if (
    msg.text &&
    !msg.text.startsWith('/') &&
    !msg.text.includes('ÐœÐ¾Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸') &&
    !msg.text.includes('Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ') &&
    !msg.text.includes('Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ')
  ) {
    const adminChatId = '1005939833';
    const userName = msg.from.username ? `@${msg.from.username}` : 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ';
    const userInfo = `Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ ${userName} (${msg.from.first_name} ${msg.from.last_name || ''}):\n\n${msg.text}`;

    bot.sendMessage(adminChatId, userInfo)
      .then(() => {
        bot.sendMessage(chatId, 'Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ! ÐœÑ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð¼ Ð²Ð°Ð¼ Ð² Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ.');
      })
      .catch(error => {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', error);
      });
  }
});

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€
app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ðŸ¤– Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ polling`);
});
