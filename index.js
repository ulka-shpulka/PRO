require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const TelegramBot = require('node-telegram-bot-api');

const app = express();

// Choose polling OR webhook mode, not both
let bot;

if (process.env.NODE_ENV === 'production') {
  // Use webhook in production
  bot = new TelegramBot(process.env.BOT_TOKEN);
  bot.setWebHook(process.env.WEBHOOK_URL || '');
} else {
  // Use polling in development
  bot = new TelegramBot(process.env.BOT_TOKEN, { 
    polling: {
      params: {
        timeout: 10
      },
      interval: 2000
    }
  });
  // Make sure to delete any existing webhook
  bot.deleteWebHook();
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸
const users = {};
const pendingBookings = {};

app.use(bodyParser.json());
app.use(cors());
app.use(express.static('public'));

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
function getLastBookingForUser(chatId) {
  const user = users[chatId];
  if (!user || !user.lastBookingId) return null;
  return pendingBookings[user.lastBookingId];
}

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
bot.onText(/\/start/, (msg) => {
  try {
    const chatId = msg.chat.id;
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñƒ Ð½Ð°Ñ ÐµÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    if (!msg.from) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ°: msg.from Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸');
      bot.sendMessage(chatId, 'ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.');
      return;
    }
    
    const username = msg.from.username || `user_${msg.from.id}`;
    console.log(`ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° /start Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${username}, chatId: ${chatId}`);
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ
    users[chatId] = { username, lastBookingId: null };

    // Ð˜Ñ‰ÐµÐ¼ Ð½ÐµÐ¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
    let availableBookings = [];
    
    for (const [id, booking] of Object.entries(pendingBookings)) {
      if (booking && booking.confirmed === false && booking.cancelled === false) {
        availableBookings.push({
          id,
          booking,
          timestamp: booking.timestamp ? new Date(booking.timestamp).getTime() : 0
        });
      }
    }
    
    // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ (Ð¾Ñ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ðº ÑÑ‚Ð°Ñ€Ñ‹Ð¼)
    availableBookings.sort((a, b) => b.timestamp - a.timestamp);
    
    // Ð‘ÐµÑ€ÐµÐ¼ ÑÐ°Ð¼ÑƒÑŽ ÑÐ²ÐµÐ¶ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ
    const newestBooking = availableBookings.length > 0 ? availableBookings[0] : null;
    
    if (newestBooking) {
      const booking = newestBooking.booking;
      const bookingId = newestBooking.id;
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ ID Ð·Ð°Ð¿Ð¸ÑÐ¸
      users[chatId].lastBookingId = bookingId;
      
      // ÐŸÑ€Ð¸Ð²ÑÐ·Ñ‹Ð²Ð°ÐµÐ¼ chatId Ðº Ð·Ð°Ð¿Ð¸ÑÐ¸
      booking.chatId = chatId;
      
      // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ Ð½Ð° undefined
      const service = booking.service || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°';
      const staff = booking.staff || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½';
      const date = booking.date || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°';
      const time = booking.time || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾';
      
      bot.sendMessage(chatId, `ðŸŽ‰ Ð’Ð°ÑˆÐ° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°:\n\nâœ¨ Ð£ÑÐ»ÑƒÐ³Ð°: ${service}\nðŸ§‘â€ðŸ’¼ Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚: ${staff}\nðŸ“… Ð”Ð°Ñ‚Ð°: ${date}\nðŸ•’ Ð’Ñ€ÐµÐ¼Ñ: ${time}`, {
        reply_markup: {
          inline_keyboard: [
            [{ text: "âœ… ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ", callback_data: `confirm_${bookingId}` }],
            [{ text: "âŒ ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ", callback_data: `cancel_${bookingId}` }]
          ]
        }
      }).catch(error => {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ Ð·Ð°Ð¿Ð¸ÑÑŒÑŽ:', error);
      });
    } else {
      // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ - Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
      bot.sendMessage(chatId, `Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Leo Beauty! âœ¨\n\nÐ”Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¿ÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° Ð½Ð°Ñˆ ÑÐ°Ð¹Ñ‚.`)
      .catch(error => {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', error);
      });
    }
  } catch (error) {
    console.error('ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð² Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐµ /start:', error);
    
    try {
      bot.sendMessage(msg.chat.id, 'ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð° Ð¿Ð¾Ð·Ð¶Ðµ.');
    } catch (e) {
      console.error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ:', e);
    }
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿Ð¾Ðº
bot.on('callback_query', async (query) => {
  try {
    const chatId = query.message.chat.id;
    const messageId = query.message.message_id;
    const [action, bookingId] = query.data.split('_');
    const booking = pendingBookings[bookingId];

    if (!booking) {
      bot.answerCallbackQuery(query.id, { text: "âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°" });
      return;
    }

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
    const service = booking.service || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°';
    const staff = booking.staff || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½';
    const date = booking.date || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°';
    const time = booking.time || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾';

    if (action === 'confirm') {
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸
      await bot.editMessageText(`âœ… Ð’Ð°Ñˆ Ð²Ð¸Ð·Ð¸Ñ‚ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½!\n\nâœ¨ Ð£ÑÐ»ÑƒÐ³Ð°: ${service}\nðŸ§‘â€ðŸ’¼ Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚: ${staff}\nðŸ“… Ð”Ð°Ñ‚Ð°: ${date}\nðŸ•’ Ð’Ñ€ÐµÐ¼Ñ: ${time}`, {
        chat_id: chatId,
        message_id: messageId,
        reply_markup: { inline_keyboard: [] } // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸
      });
      
      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸ÐµÐ¼
      await bot.sendMessage(chatId, "âœ… Ð’Ð°ÑˆÐ° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð°! Ð–Ð´ÐµÐ¼ Ð²Ð°Ñ Ð² Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ.");
      
      // ÐŸÐ¾Ð¼ÐµÑ‡Ð°ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ ÐºÐ°Ðº Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð½ÑƒÑŽ
      booking.confirmed = true;
      booking.cancelled = false;
      
      // ÐžÑ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Ð½Ð° callback query
      bot.answerCallbackQuery(query.id, { text: "Ð—Ð°Ð¿Ð¸ÑÑŒ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð°!" });
    } else if (action === 'cancel') {
      // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸
      await bot.editMessageText(`âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°\n\nâœ¨ Ð£ÑÐ»ÑƒÐ³Ð°: ${service}\nðŸ§‘â€ðŸ’¼ Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚: ${staff}\nðŸ“… Ð”Ð°Ñ‚Ð°: ${date}\nðŸ•’ Ð’Ñ€ÐµÐ¼Ñ: ${time}`, {
        chat_id: chatId,
        message_id: messageId,
        reply_markup: { inline_keyboard: [] } // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸
      });
      
      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾Ñ‚Ð¼ÐµÐ½Ðµ
      await bot.sendMessage(chatId, "âŒ Ð’Ð°ÑˆÐ° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°.");
      
      // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¸Ð· ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
      delete pendingBookings[bookingId];
      
      // ÐžÑ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Ð½Ð° callback query
      bot.answerCallbackQuery(query.id, { text: "Ð—Ð°Ð¿Ð¸ÑÑŒ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°!" });
    }
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÐºÐ½Ð¾Ð¿ÐºÐ¸:', error);
    
    try {
      // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ, Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°
      if (query && query.message && query.message.chat && query.message.chat.id) {
        await bot.sendMessage(query.message.chat.id, "ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.");
      }
      
      if (query && query.id) {
        bot.answerCallbackQuery(query.id, { text: "ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°" });
      }
    } catch (sendError) {
      console.error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ:', sendError);
    }
  }
});

// Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸
app.post('/api/pending-booking', (req, res) => {
  try {
    const { userId, service, staff, date, time } = req.body;
    
    if (!userId) {
      return res.status(400).json({ 
        success: false, 
        message: 'ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð»Ðµ userId' 
      });
    }
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
    pendingBookings[userId] = { 
      service, 
      staff, 
      date, 
      time, 
      timestamp: new Date().toISOString(),
      confirmed: false,
      cancelled: false
    };
    
    console.log(`ÐÐ¾Ð²Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð°: ${JSON.stringify(pendingBookings[userId])}`);
    res.json({ success: true });
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸:', error);
    res.status(500).json({ success: false, message: 'Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// Webhook endpoint for production mode
if (process.env.NODE_ENV === 'production') {
  app.post(`/webhook/${process.env.BOT_TOKEN}`, (req, res) => {
    bot.processUpdate(req.body);
    res.sendStatus(200);
  });
}

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const port = process.env.PORT || 3000;
app.listen(port, () => console.log(`Server running on port ${port}`));